"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.Controller = void 0;

var _nodeFetch = _interopRequireDefault(require("node-fetch"));

var _user = _interopRequireDefault(require("../../services/user.service"));

var _helpers = require("../../../helpers");

var _token = _interopRequireDefault(require("../../models/token"));

var _randomstring = _interopRequireDefault(require("randomstring"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

class Controller {
  async signUp(req, res) {
    try {
      const user = await _user.default.getUserByEmail(req.body.email);

      if (user) {
        if (!user.isVerified) {
          await _helpers.EmailHelpers.sendEmailToVerifyAccount(user, req, res);
          return res.status(400).json({
            verified: false,
            message: 'Your account is not verified, Please check your Email'
          });
        }

        return res.status(400).json({
          message: 'User already Exist'
        });
      }

      req.body.role = 'admin';

      const newUser = _user.default.userObject(req);

      await _user.default.registerUser(newUser);
      await _helpers.EmailHelpers.sendEmailToVerifyAccount(newUser, req, res);
      res.status(201).json({
        success: true,
        message: 'Account is successfully created and email has been sent.'
      });
    } catch (error) {
      res.status(500).json({
        success: false,
        message: error.message
      });
    }
  }

  async signIn(req, res) {
    try {
      const {
        email,
        password
      } = req.body;
      const user = await _user.default.getUserByEmail(email);

      if (user) {
        if (!user.isVerified) {
          await _helpers.EmailHelpers.sendEmailToVerifyAccount(user, req, res);
          return res.status(401).json({
            message: 'Your account has not been verified, Please check your Email',
            verified: false
          });
        }

        if (!user.comparePassword(password)) {
          return res.status(401).json({
            message: 'Invalid email or password'
          });
        }

        const token = user.generateJWT();
        return res.status(200).json({
          message: 'successfully logged in',
          data: {
            user,
            token
          }
        });
      } else {
        return res.status(500).json({
          message: "Email doesn't not exists"
        });
      }
    } catch (error) {
      res.status(500).send(error);
    }
  }

  async facebookSignIn(req, res) {
    try {
      const {
        userId,
        accessToken
      } = req.body;
      const facebookUrl = `https://graph.facebook.com/${userId}?fields=id,email,first_name,last_name,picture&access_token=${accessToken}`;
      (0, _nodeFetch.default)(facebookUrl, {
        method: 'GET'
      }).then(res => res.json()).then(async result => {
        const {
          email,
          first_name,
          last_name
        } = result;
        const user = await _user.default.getUserByEmail(email);

        if (user) {
          const token = user.generateJWT();

          if (!token) {
            return res.status(400).json({
              message: 'error in generating Code'
            });
          }

          return res.status(200).json({
            message: 'successfully logged in',
            data: {
              user,
              token
            }
          });
        } else {
          const data = {
            body: {
              firstName: first_name,
              lastName: last_name,
              role: 'admin',
              email,
              password: email + _randomstring.default.generate()
            }
          };

          const newUser = _user.default.userObject(data);

          const user = await _user.default.registerUser(newUser);
          const token = user.generateJWT();

          if (!token) {
            return res.status(400).json({
              message: 'error in generating Code'
            });
          }

          return res.status(200).json({
            message: 'successfully logged in',
            data: {
              user,
              token
            }
          });
        }
      }).catch(error => res.status(500).json({
        message: error.message
      }));
    } catch (error) {
      res.status(500).json({
        message: error.message
      });
    }
  }

  async googleSignIn(req, res) {
    try {
      const {
        token
      } = req.body;
      const data = await (0, _helpers.verifyGoogleToken)(token);
      const {
        email,
        given_name,
        family_name,
        picture
      } = data;
      const user = await _user.default.getUserByEmail(email);

      if (user) {
        const token = user.generateJWT();

        if (!token) {
          return res.status(400).json({
            message: 'error in generating Code'
          });
        }

        return res.status(200).json({
          message: 'successfully logged in',
          data: {
            user,
            token
          }
        });
      } else {
        const data = {
          body: {
            firstName: given_name,
            lastName: family_name,
            avatar: picture,
            role: 'admin',
            email,
            password: email + _randomstring.default.generate()
          }
        };

        const newUser = _user.default.userObject(data);

        const user = await _user.default.registerUser(newUser);
        const token = user.generateJWT();

        if (!token) {
          return res.status(400).json({
            message: 'error in generating Code'
          });
        }

        return res.status(200).json({
          message: 'successfully logged in',
          data: {
            user,
            token
          }
        });
      }
    } catch (error) {
      res.status(500).json({
        message: error.message
      });
    }
  }

  async forgotPassword(req, res) {
    try {
      const {
        email
      } = req.body;
      const user = await _user.default.getUserByEmail(email);
      if (!user) return res.status(401).json({
        message: 'The email address ' + req.body.email + ' is not associated with any account'
      });
      await _helpers.EmailHelpers.sendForgotPasswordCode(user, req, res);
    } catch (error) {
      res.status(500).json({
        message: error.message
      });
    }
  }

  async verify(req, res) {
    if (!req.body.token) return res.status(400).json({
      message: 'token is not provided'
    });

    try {
      const token = await _token.default.findOne({
        token: req.body.token
      });

      if (!token) {
        return res.status(400).json({
          message: 'invalid Token'
        });
      }

      const user = await _user.default.getUserById(token.userId);

      if (!user) {
        return res.status(400).json({
          message: 'no user for this token'
        });
      }

      if (user.isVerified) {
        res.status(400).json({
          message: ' user has already been verified'
        });
      }

      user.isVerified = true;
      await _user.default.registerUser(user);
      res.status(201).json({
        success: true,
        message: 'Account is successfully verified'
      });
    } catch (error) {
      res.status(500).json({
        message: error.message
      });
    }
  }

  async resend(req, res) {
    try {
      const {
        email
      } = req.body;
      const user = await _user.default.getUserByEmail(email);
      if (!user) return res.status(401).json({
        message: 'The email address ' + req.body.email + ' is not associated with any account'
      });
      if (user.isVerified) res.status(400).json({
        message: 'This account has already been verified'
      }); //    await EmailHelpers.sendEmailToVerifyAccount(user, req, res, true);
    } catch (error) {
      res.status(500).json({
        message: error.message
      });
    }
  }

  async resetPassword(req, res) {
    const {
      password
    } = req.body;

    try {
      const token = await _token.default.findOne({
        token: req.body.token
      });

      if (!token) {
        return res.status(400).json({
          message: 'invalid Token or expired'
        });
      }

      const user = await _user.default.getUserById(token.userId);

      if (!user) {
        return res.status(400).json({
          message: 'no user for this token'
        });
      }

      user.password = password;
      await _user.default.registerUser(user);
      res.status(201).json({
        success: true,
        message: 'Password reset successfully, Sign in to continue'
      });
    } catch (error) {
      res.status(500).json({
        message: error.message
      });
    }
  }

}

exports.Controller = Controller;

var _default = new Controller();

exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NlcnZlci9hcGkvY29udHJvbGxlcnMvYXV0aC9jb250cm9sbGVyLmpzIl0sIm5hbWVzIjpbIkNvbnRyb2xsZXIiLCJzaWduVXAiLCJyZXEiLCJyZXMiLCJ1c2VyIiwidXNlclNlcnZpY2UiLCJnZXRVc2VyQnlFbWFpbCIsImJvZHkiLCJlbWFpbCIsImlzVmVyaWZpZWQiLCJFbWFpbEhlbHBlcnMiLCJzZW5kRW1haWxUb1ZlcmlmeUFjY291bnQiLCJzdGF0dXMiLCJqc29uIiwidmVyaWZpZWQiLCJtZXNzYWdlIiwicm9sZSIsIm5ld1VzZXIiLCJ1c2VyT2JqZWN0IiwicmVnaXN0ZXJVc2VyIiwic3VjY2VzcyIsImVycm9yIiwic2lnbkluIiwicGFzc3dvcmQiLCJjb21wYXJlUGFzc3dvcmQiLCJ0b2tlbiIsImdlbmVyYXRlSldUIiwiZGF0YSIsInNlbmQiLCJmYWNlYm9va1NpZ25JbiIsInVzZXJJZCIsImFjY2Vzc1Rva2VuIiwiZmFjZWJvb2tVcmwiLCJtZXRob2QiLCJ0aGVuIiwicmVzdWx0IiwiZmlyc3RfbmFtZSIsImxhc3RfbmFtZSIsImZpcnN0TmFtZSIsImxhc3ROYW1lIiwicmFuZG9tU3RyaW5nIiwiZ2VuZXJhdGUiLCJjYXRjaCIsImdvb2dsZVNpZ25JbiIsImdpdmVuX25hbWUiLCJmYW1pbHlfbmFtZSIsInBpY3R1cmUiLCJhdmF0YXIiLCJmb3Jnb3RQYXNzd29yZCIsInNlbmRGb3Jnb3RQYXNzd29yZENvZGUiLCJ2ZXJpZnkiLCJUb2tlbiIsImZpbmRPbmUiLCJnZXRVc2VyQnlJZCIsInJlc2VuZCIsInJlc2V0UGFzc3dvcmQiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7QUFBQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7OztBQUNPLE1BQU1BLFVBQU4sQ0FBaUI7QUFDVixRQUFOQyxNQUFNLENBQUNDLEdBQUQsRUFBTUMsR0FBTixFQUFXO0FBQ3JCLFFBQUk7QUFDRixZQUFNQyxJQUFJLEdBQUcsTUFBTUMsY0FBWUMsY0FB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LFlBQU1sQixjQUFZYyxZQUFaLENBQXlCZixJQUF6QixDQUFOO0FBQ0FELE1BQUFBLEdBQUcsQ0FBQ1MsTUFBSixDQUFXLEdBQVgsRUFBZ0JDLElBQWhCLENBQXFCO0FBQ25CTyxRQUFBQSxPQUFPLEVBQUUsSUFEVTtBQUVuQkwsUUFBQUEsT0FBTyxFQUFFO0FBRlUsT0FBckI7QUFJRCxLQWZELENBZUUsT0FBT00sS0FBUCxFQUFjO0FBQ2RsQixNQUFBQSxHQUFHLENBQUNTLE1BQUosQ0FBVyxHQUFYLEVBQWdCQyxJQUFoQixDQUFxQjtBQUFFRSxRQUFBQSxPQUFPLEVBQUVNLEtBQUssQ0FBQ047QUFBakIsT0FBckI7QUFDRDtBQUNGOztBQWpRcUI7Ozs7ZUFtUVQsSUFBSWYsVUFBSixFIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IGZldGNoIGZyb20gJ25vZGUtZmV0Y2gnO1xuaW1wb3J0IHVzZXJTZXJ2aWNlIGZyb20gJy4uLy4uL3NlcnZpY2VzL3VzZXIuc2VydmljZSc7XG5pbXBvcnQgeyBFbWFpbEhlbHBlcnMsIHZlcmlmeUdvb2dsZVRva2VuIH0gZnJvbSAnLi4vLi4vLi4vaGVscGVycyc7XG5pbXBvcnQgVG9rZW4gZnJvbSAnLi4vLi4vbW9kZWxzL3Rva2VuJztcbmltcG9ydCByYW5kb21TdHJpbmcgZnJvbSAncmFuZG9tc3RyaW5nJztcbmV4cG9ydCBjbGFzcyBDb250cm9sbGVyIHtcbiAgYXN5bmMgc2lnblVwKHJlcSwgcmVzKSB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHVzZXIgPSBhd2FpdCB1c2VyU2VydmljZS5nZXRVc2VyQnlFbWFpbChyZXEuYm9keS5lbWFpbCk7XG4gICAgICBpZiAodXNlcikge1xuICAgICAgICBpZiAoIXVzZXIuaXNWZXJpZmllZCkge1xuICAgICAgICAgIGF3YWl0IEVtYWlsSGVscGVycy5zZW5kRW1haWxUb1ZlcmlmeUFjY291bnQodXNlciwgcmVxLCByZXMpO1xuICAgICAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwMCkuanNvbih7XG4gICAgICAgICAgICB2ZXJpZmllZDogZmFsc2UsXG4gICAgICAgICAgICBtZXNzYWdlOiAnWW91ciBhY2NvdW50IGlzIG5vdCB2ZXJpZmllZCwgUGxlYXNlIGNoZWNrIHlvdXIgRW1haWwnLFxuICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwMCkuanNvbih7IG1lc3NhZ2U6ICdVc2VyIGFscmVhZHkgRXhpc3QnIH0pO1xuICAgICAgfVxuICAgICAgcmVxLmJvZHkucm9sZSA9ICdhZG1pbic7XG4gICAgICBjb25zdCBuZXdVc2VyID0gdXNlclNlcnZpY2UudXNlck9iamVjdChyZXEpO1xuICAgICAgYXdhaXQgdXNlclNlcnZpY2UucmVnaXN0ZXJVc2VyKG5ld1VzZXIpO1xuICAgICAgYXdhaXQgRW1haWxIZWxwZXJzLnNlbmRFbWFpbFRvVmVyaWZ5QWNjb3VudChuZXdVc2VyLCByZXEsIHJlcyk7XG4gICAgICByZXMuc3RhdHVzKDIwMSkuanNvbih7XG4gICAgICAgIHN1Y2Nlc3M6IHRydWUsXG4gICAgICAgIG1lc3NhZ2U6ICdBY2NvdW50IGlzIHN1Y2Nlc3NmdWxseSBjcmVhdGVkIGFuZCBlbWFpbCBoYXMgYmVlbiBzZW50LicsXG4gICAgICB9KTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgcmVzLnN0YXR1cyg1MDApLmpzb24oe1xuICAgICAgICBzdWNjZXNzOiBmYWxzZSxcbiAgICAgICAgbWVzc2FnZTogZXJyb3IubWVzc2FnZSxcbiAgICAgIH0pO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIHNpZ25JbihyZXEsIHJlcykge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCB7IGVtYWlsLCBwYXNzd29yZCB9ID0gcmVxLmJvZHk7XG4gICAgICBjb25zdCB1c2VyID0gYXdhaXQgdXNlclNlcnZpY2UuZ2V0VXNlckJ5RW1haWwoZW1haWwpO1xuICAgICAgaWYgKHVzZXIpIHtcbiAgICAgICAgaWYgKCF1c2VyLmlzVmVyaWZpZWQpIHtcbiAgICAgICAgICBhd2FpdCBFbWFpbEhlbHBlcnMuc2VuZEVtYWlsVG9WZXJpZnlBY2NvdW50KHVzZXIsIHJlcSwgcmVzKTtcbiAgICAgICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDEpLmpzb24oe1xuICAgICAgICAgICAgbWVzc2FnZTpcbiAgICAgICAgICAgICAgJ1lvdXIgYWNjb3VudCBoYXMgbm90IGJlZW4gdmVyaWZpZWQsIFBsZWFzZSBjaGVjayB5b3VyIEVtYWlsJyxcbiAgICAgICAgICAgIHZlcmlmaWVkOiBmYWxzZSxcbiAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgICAgICBpZiAoIXVzZXIuY29tcGFyZVBhc3N3b3JkKHBhc3N3b3JkKSkge1xuICAgICAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwMSkuanNvbih7IG1lc3NhZ2U6ICdJbnZhbGlkIGVtYWlsIG9yIHBhc3N3b3JkJyB9KTtcbiAgICAgICAgfVxuICAgICAgICBjb25zdCB0b2tlbiA9IHVzZXIuZ2VuZXJhdGVKV1QoKTtcbiAgICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoMjAwKS5qc29uKHtcbiAgICAgICAgICBtZXNzYWdlOiAnc3VjY2Vzc2Z1bGx5IGxvZ2dlZCBpbicsXG4gICAgICAgICAgZGF0YToge1xuICAgICAgICAgICAgdXNlcixcbiAgICAgICAgICAgIHRva2VuLFxuICAgICAgICAgIH0sXG4gICAgICAgIH0pO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNTAwKS5qc29uKHtcbiAgICAgICAgICBtZXNzYWdlOiBcIkVtYWlsIGRvZXNuJ3Qgbm90IGV4aXN0c1wiLFxuICAgICAgICB9KTtcbiAgICAgIH1cbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgcmVzLnN0YXR1cyg1MDApLnNlbmQoZXJyb3IpO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIGZhY2Vib29rU2lnbkluKHJlcSwgcmVzKSB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHsgdXNlcklkLCBhY2Nlc3NUb2tlbiB9ID0gcmVxLmJvZHk7XG4gICAgICBjb25zdCBmYWNlYm9va1VybCA9IGBodHRwczovL2dyYXBoLmZhY2Vib29rLmNvbS8ke3VzZXJJZH0/ZmllbGRzPWlkLGVtYWlsLGZpcnN0X25hbWUsbGFzdF9uYW1lLHBpY3R1cmUmYWNjZXNzX3Rva2VuPSR7YWNjZXNzVG9rZW59YDtcblxuICAgICAgZmV0Y2goZmFjZWJvb2tVcmwsIHtcbiAgICAgICAgbWV0aG9kOiAnR0VUJyxcbiAgICAgIH0pXG4gICAgICAgIC50aGVuKChyZXMpID0+IHJlcy5qc29uKCkpXG4gICAgICAgIC50aGVuKGFzeW5jIChyZXN1bHQpID0+IHtcbiAgICAgICAgICBjb25zdCB7IGVtYWlsLCBmaXJzdF9uYW1lLCBsYXN0X25hbWUgfSA9IHJlc3VsdDtcbiAgICAgICAgICBjb25zdCB1c2VyID0gYXdhaXQgdXNlclNlcnZpY2UuZ2V0VXNlckJ5RW1haWwoZW1haWwpO1xuICAgICAgICAgIGlmICh1c2VyKSB7XG4gICAgICAgICAgICBjb25zdCB0b2tlbiA9IHVzZXIuZ2VuZXJhdGVKV1QoKTtcbiAgICAgICAgICAgIGlmICghdG9rZW4pIHtcbiAgICAgICAgICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDAwKS5qc29uKHtcbiAgICAgICAgICAgICAgICBtZXNzYWdlOiAnZXJyb3IgaW4gZ2VuZXJhdGluZyBDb2RlJyxcbiAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gcmVzLnN0YXR1cygyMDApLmpzb24oe1xuICAgICAgICAgICAgICBtZXNzYWdlOiAnc3VjY2Vzc2Z1bGx5IGxvZ2dlZCBpbicsXG4gICAgICAgICAgICAgIGRhdGE6IHtcbiAgICAgICAgICAgICAgICB1c2VyLFxuICAgICAgICAgICAgICAgIHRva2VuLFxuICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGNvbnN0IGRhdGEgPSB7XG4gICAgICAgICAgICAgIGJvZHk6IHtcbiAgICAgICAgICAgICAgICBmaXJzdE5hbWU6IGZpcnN0X25hbWUsXG4gICAgICAgICAgICAgICAgbGFzdE5hbWU6IGxhc3RfbmFtZSxcbiAgICAgICAgICAgICAgICByb2xlOiAnYWRtaW4nLFxuICAgICAgICAgICAgICAgIGVtYWlsLFxuICAgICAgICAgICAgICAgIHBhc3N3b3JkOiBlbWFpbCArIHJhbmRvbVN0cmluZy5nZW5lcmF0ZSgpLFxuICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIGNvbnN0IG5ld1VzZXIgPSB1c2VyU2VydmljZS51c2VyT2JqZWN0KGRhdGEpO1xuICAgICAgICAgICAgY29uc3QgdXNlciA9IGF3YWl0IHVzZXJTZXJ2aWNlLnJlZ2lzdGVyVXNlcihuZXdVc2VyKTtcbiAgICAgICAgICAgIGNvbnN0IHRva2VuID0gdXNlci5nZW5lcmF0ZUpXVCgpO1xuICAgICAgICAgICAgaWYgKCF0b2tlbikge1xuICAgICAgICAgICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDApLmpzb24oe1xuICAgICAgICAgICAgICAgIG1lc3NhZ2U6ICdlcnJvciBpbiBnZW5lcmF0aW5nIENvZGUnLFxuICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiByZXMuc3RhdHVzKDIwMCkuanNvbih7XG4gICAgICAgICAgICAgIG1lc3NhZ2U6ICdzdWNjZXNzZnVsbHkgbG9nZ2VkIGluJyxcbiAgICAgICAgICAgICAgZGF0YToge1xuICAgICAgICAgICAgICAgIHVzZXIsXG4gICAgICAgICAgICAgICAgdG9rZW4sXG4gICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICB9XG4gICAgICAgIH0pXG4gICAgICAgIC5jYXRjaCgoZXJyb3IpID0+IHJlcy5zdGF0dXMoNTAwKS5qc29uKHsgbWVzc2FnZTogZXJyb3IubWVzc2FnZSB9KSk7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIHJlcy5zdGF0dXMoNTAwKS5qc29uKHsgbWVzc2FnZTogZXJyb3IubWVzc2FnZSB9KTtcbiAgICB9XG4gIH1cblxuICBhc3luYyBnb29nbGVTaWduSW4ocmVxLCByZXMpIHtcbiAgICB0cnkge1xuICAgICAgY29uc3QgeyB0b2tlbiB9ID0gcmVxLmJvZHk7XG4gICAgICBjb25zdCBkYXRhID0gYXdhaXQgdmVyaWZ5R29vZ2xlVG9rZW4odG9rZW4pO1xuICAgICAgY29uc3QgeyBlbWFpbCwgZ2l2ZW5fbmFtZSwgZmFtaWx5X25hbWUsIHBpY3R1cmUgfSA9IGRhdGE7XG4gICAgICBjb25zdCB1c2VyID0gYXdhaXQgdXNlclNlcnZpY2UuZ2V0VXNlckJ5RW1haWwoZW1haWwpO1xuICAgICAgaWYgKHVzZXIpIHtcbiAgICAgICAgY29uc3QgdG9rZW4gPSB1c2VyLmdlbmVyYXRlSldUKCk7XG4gICAgICAgIGlmICghdG9rZW4pIHtcbiAgICAgICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDApLmpzb24oe1xuICAgICAgICAgICAgbWVzc2FnZTogJ2Vycm9yIGluIGdlbmVyYXRpbmcgQ29kZScsXG4gICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoMjAwKS5qc29uKHtcbiAgICAgICAgICBtZXNzYWdlOiAnc3VjY2Vzc2Z1bGx5IGxvZ2dlZCBpbicsXG4gICAgICAgICAgZGF0YToge1xuICAgICAgICAgICAgdXNlcixcbiAgICAgICAgICAgIHRva2VuLFxuICAgICAgICAgIH0sXG4gICAgICAgIH0pO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgY29uc3QgZGF0YSA9IHtcbiAgICAgICAgICBib2R5OiB7XG4gICAgICAgICAgICBmaXJzdE5hbWU6IGdpdmVuX25hbWUsXG4gICAgICAgICAgICBsYXN0TmFtZTogZmFtaWx5X25hbWUsXG4gICAgICAgICAgICBhdmF0YXI6IHBpY3R1cmUsXG4gICAgICAgICAgICByb2xlOiAnYWRtaW4nLFxuICAgICAgICAgICAgZW1haWwsXG4gICAgICAgICAgICBwYXNzd29yZDogZW1haWwgKyByYW5kb21TdHJpbmcuZ2VuZXJhdGUoKSxcbiAgICAgICAgICB9LFxuICAgICAgICB9O1xuICAgICAgICBjb25zdCBuZXdVc2VyID0gdXNlclNlcnZpY2UudXNlck9iamVjdChkYXRhKTtcbiAgICAgICAgY29uc3QgdXNlciA9IGF3YWl0IHVzZXJTZXJ2aWNlLnJlZ2lzdGVyVXNlcihuZXdVc2VyKTtcbiAgICAgICAgY29uc3QgdG9rZW4gPSB1c2VyLmdlbmVyYXRlSldUKCk7XG4gICAgICAgIGlmICghdG9rZW4pIHtcbiAgICAgICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDApLmpzb24oe1xuICAgICAgICAgICAgbWVzc2FnZTogJ2Vycm9yIGluIGdlbmVyYXRpbmcgQ29kZScsXG4gICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoMjAwKS5qc29uKHtcbiAgICAgICAgICBtZXNzYWdlOiAnc3VjY2Vzc2Z1bGx5IGxvZ2dlZCBpbicsXG4gICAgICAgICAgZGF0YToge1xuICAgICAgICAgICAgdXNlcixcbiAgICAgICAgICAgIHRva2VuLFxuICAgICAgICAgIH0sXG4gICAgICAgIH0pO1xuICAgICAgfVxuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICByZXMuc3RhdHVzKDUwMCkuanNvbih7IG1lc3NhZ2U6IGVycm9yLm1lc3NhZ2UgfSk7XG4gICAgfVxuICB9XG4gIGFzeW5jIGZvcmdvdFBhc3N3b3JkKHJlcSwgcmVzKSB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHsgZW1haWwgfSA9IHJlcS5ib2R5O1xuICAgICAgY29uc3QgdXNlciA9IGF3YWl0IHVzZXJTZXJ2aWNlLmdldFVzZXJCeUVtYWlsKGVtYWlsKTtcbiAgICAgIGlmICghdXNlcilcbiAgICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDAxKS5qc29uKHtcbiAgICAgICAgICBtZXNzYWdlOlxuICAgICAgICAgICAgJ1RoZSBlbWFpbCBhZGRyZXNzICcgK1xuICAgICAgICAgICAgcmVxLmJvZHkuZW1haWwgK1xuICAgICAgICAgICAgJyBpcyBub3QgYXNzb2NpYXRlZCB3aXRoIGFueSBhY2NvdW50JyxcbiAgICAgICAgfSk7XG4gICAgICBhd2FpdCBFbWFpbEhlbHBlcnMuc2VuZEZvcmdvdFBhc3N3b3JkQ29kZSh1c2VyLCByZXEsIHJlcyk7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIHJlcy5zdGF0dXMoNTAwKS5qc29uKHsgbWVzc2FnZTogZXJyb3IubWVzc2FnZSB9KTtcbiAgICB9XG4gIH1cblxuICBhc3luYyB2ZXJpZnkocmVxLCByZXMpIHtcbiAgICBpZiAoIXJlcS5ib2R5LnRva2VuKVxuICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDAwKS5qc29uKHsgbWVzc2FnZTogJ3Rva2VuIGlzIG5vdCBwcm92aWRlZCcgfSk7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHRva2VuID0gYXdhaXQgVG9rZW4uZmluZE9uZSh7IHRva2VuOiByZXEuYm9keS50b2tlbiB9KTtcbiAgICAgIGlmICghdG9rZW4pIHtcbiAgICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDAwKS5qc29uKHsgbWVzc2FnZTogJ2ludmFsaWQgVG9rZW4nIH0pO1xuICAgICAgfVxuICAgICAgY29uc3QgdXNlciA9IGF3YWl0IHVzZXJTZXJ2aWNlLmdldFVzZXJCeUlkKHRva2VuLnVzZXJJZCk7XG4gICAgICBpZiAoIXVzZXIpIHtcbiAgICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDAwKS5qc29uKHsgbWVzc2FnZTogJ25vIHVzZXIgZm9yIHRoaXMgdG9rZW4nIH0pO1xuICAgICAgfVxuICAgICAgaWYgKHVzZXIuaXNWZXJpZmllZCkge1xuICAgICAgICByZXMuc3RhdHVzKDQwMCkuanNvbih7IG1lc3NhZ2U6ICcgdXNlciBoYXMgYWxyZWFkeSBiZWVuIHZlcmlmaWVkJyB9KTtcbiAgICAgIH1cbiAgICAgIHVzZXIuaXNWZXJpZmllZCA9IHRydWU7XG4gICAgICBhd2FpdCB1c2VyU2VydmljZS5yZWdpc3RlclVzZXIodXNlcik7XG4gICAgICByZXMuc3RhdHVzKDIwMSkuanNvbih7XG4gICAgICAgIHN1Y2Nlc3M6IHRydWUsXG4gICAgICAgIG1lc3NhZ2U6ICdBY2NvdW50IGlzIHN1Y2Nlc3NmdWxseSB2ZXJpZmllZCcsXG4gICAgICB9KTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgcmVzLnN0YXR1cyg1MDApLmpzb24oeyBtZXNzYWdlOiBlcnJvci5tZXNzYWdlIH0pO1xuICAgIH1cbiAgfVxuICBhc3luYyByZXNlbmQocmVxLCByZXMpIHtcbiAgICB0cnkge1xuICAgICAgY29uc3QgeyBlbWFpbCB9ID0gcmVxLmJvZHk7XG4gICAgICBjb25zdCB1c2VyID0gYXdhaXQgdXNlclNlcnZpY2UuZ2V0VXNlckJ5RW1haWwoZW1haWwpO1xuICAgICAgaWYgKCF1c2VyKVxuICAgICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDEpLmpzb24oe1xuICAgICAgICAgIG1lc3NhZ2U6XG4gICAgICAgICAgICAnVGhlIGVtYWlsIGFkZHJlc3MgJyArXG4gICAgICAgICAgICByZXEuYm9keS5lbWFpbCArXG4gICAgICAgICAgICAnIGlzIG5vdCBhc3NvY2lhdGVkIHdpdGggYW55IGFjY291bnQnLFxuICAgICAgICB9KTtcbiAgICAgIGlmICh1c2VyLmlzVmVyaWZpZWQpXG4gICAgICAgIHJlc1xuICAgICAgICAgIC5zdGF0dXMoNDAwKVxuICAgICAgICAgIC5qc29uKHsgbWVzc2FnZTogJ1RoaXMgYWNjb3VudCBoYXMgYWxyZWFkeSBiZWVuIHZlcmlmaWVkJyB9KTtcbiAgICAgIC8vICAgIGF3YWl0IEVtYWlsSGVscGVycy5zZW5kRW1haWxUb1ZlcmlmeUFjY291bnQodXNlciwgcmVxLCByZXMsIHRydWUpO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICByZXMuc3RhdHVzKDUwMCkuanNvbih7IG1lc3NhZ2U6IGVycm9yLm1lc3NhZ2UgfSk7XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgcmVzZXRQYXNzd29yZChyZXEsIHJlcykge1xuICAgIGNvbnN0IHsgcGFzc3dvcmQgfSA9IHJlcS5ib2R5O1xuICAgIHRyeSB7XG4gICAgICBjb25zdCB0b2tlbiA9IGF3YWl0IFRva2VuLmZpbmRPbmUoeyB0b2tlbjogcmVxLmJvZHkudG9rZW4gfSk7XG4gICAgICBpZiAoIXRva2VuKSB7XG4gICAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwMCkuanNvbih7IG1lc3NhZ2U6ICdpbnZhbGlkIFRva2VuIG9yIGV4cGlyZWQnIH0pO1xuICAgICAgfVxuICAgICAgY29uc3QgdXNlciA9IGF3YWl0IHVzZXJTZXJ2aWNlLmdldFVzZXJCeUlkKHRva2VuLnVzZXJJZCk7XG4gICAgICBpZiAoIXVzZXIpIHtcbiAgICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDAwKS5qc29uKHsgbWVzc2FnZTogJ25vIHVzZXIgZm9yIHRoaXMgdG9rZW4nIH0pO1xuICAgICAgfVxuICAgICAgdXNlci5wYXNzd29yZCA9IHBhc3N3b3JkO1xuICAgICAgYXdhaXQgdXNlclNlcnZpY2UucmVnaXN0ZXJVc2VyKHVzZXIpO1xuICAgICAgcmVzLnN0YXR1cygyMDEpLmpzb24oe1xuICAgICAgICBzdWNjZXNzOiB0cnVlLFxuICAgICAgICBtZXNzYWdlOiAnUGFzc3dvcmQgcmVzZXQgc3VjY2Vzc2Z1bGx5LCBTaWduIGluIHRvIGNvbnRpbnVlJyxcbiAgICAgIH0pO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICByZXMuc3RhdHVzKDUwMCkuanNvbih7IG1lc3NhZ2U6IGVycm9yLm1lc3NhZ2UgfSk7XG4gICAgfVxuICB9XG59XG5leHBvcnQgZGVmYXVsdCBuZXcgQ29udHJvbGxlcigpO1xuIl19