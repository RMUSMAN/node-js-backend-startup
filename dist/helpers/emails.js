"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.sendInviteEmail = exports.sendForgotPasswordCode = exports.sendEmailToVerifyAccount = exports.randomString = void 0;

const sgMail = require('@sendgrid/mail'); //const Token = require('../api/models/token');


sgMail.setApiKey(process.env.SENDGRID_API_KEY);

const sendEmailToVerifyAccount = async (user, req, res, resend = false) => {
  const token = user.generateVerificationToken();

  try {
    await token.save();
    const msg = {
      to: user.email,
      from: {
        email: process.env.SMTP_EMAIL,
        name: 'Hashlogics'
      },
      templateId: process.env.TEMPLATE_ID,
      dynamic_template_data: {
        subject: 'Your Hashlogics email verification request',
        // name: `${user.firstName} ${user.lastName}`,
        code: token.token,
        for: 'verify your account'
      }
    };
    await sgMail.send(msg);
    return;
  } catch (err) {
    if (resend === true) {
      return res.status(500).json({
        error: err.message,
        message: 'Email sending failed'
      });
    } else {
      return res.status(500).json({
        error: err.message,
        accountCreated: true,
        isEmailSent: false,
        message: 'Account is created successfully . But failed to send email, please send email again'
      });
    }
  }
};

exports.sendEmailToVerifyAccount = sendEmailToVerifyAccount;

const sendForgotPasswordCode = async (user, req, res) => {
  const token = user.generateVerificationToken();

  try {
    await token.save();
    const msg = {
      to: user.email,
      from: {
        email: process.env.SMTP_EMAIL,
        name: 'Hashlogics'
      },
      templateId: process.env.TEMPLATE_ID,
      dynamic_template_data: {
        subject: 'Your Hashlogics password reset request',
        // name: `${user.firstName} ${user.lastName}`,
        code: token.token,
        fromname: 'Hashlogics',
        for: 'reset your account'
      }
    };
    await sgMail.send(msg);
    res.status(200).json({
      message: 'Your account has not been verified, Please check your Email'
    });
  } catch (err) {
    return res.status(500).json({
      error: err.message
    });
  }
};

exports.sendForgotPasswordCode = sendForgotPasswordCode;

const sendInviteEmail = async (user, link, req, res) => {
  try {
    const msg = {
      to: user.email,
      from: {
        email: process.env.SMTP_EMAIL,
        name: 'Hashlogics'
      },
      templateId: process.env.INVITE_TEMPLATE_ID,
      dynamic_template_data: {
        subject: `You have been added as a ${user.role} within Hashlogics`,
        heading: 'Welcome to Hashlogics!',
        description: `You have been added as a ${user.role} within Hashlogics. Please follow the link below to get started and to set up your Hashlogics profile`,
        preHeader: `You have been added as a supervisor within Hashlogics`,
        link: link
      }
    };
    await sgMail.send(msg);
    return;
  } catch (err) {
    return res.status(500).json({
      error: err.message
    });
  }
};

exports.sendInviteEmail = sendInviteEmail;

const randomString = () => {
  const number = Math.random().toFixed(36).substring(2, 7);
  return number;
};

exports.randomString = randomString;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NlcnZlci9oZWxwZXJzL2VtYWlscy5qcyJdLCJuYW1lcyI6WyJzZ01haWwiLCJyZXF1aXJlIiwic2V0QXBpS2V5IiwicHJvY2VzcyIsImVudiIsIlNFTkRHUklEX0FQSV9LRVkiLCJzZW5kRW1haWxUb1ZlcmlmeUFjY291bnQiLCJ1c2VyIiwicmVxIiwicmVzIiwicmVzZW5kIiwidG9rZW4iLCJnZW5lcmF0ZVZlcmlmaWNhdGlvblRva2VuIiwic2F2ZSIsIm1zZyIsInRvIiwiZW1haWwiLCJmcm9tIiwiU01UUF9FTUFJTCIsIm5hbWUiLCJ0ZW1wbGF0ZUlkIiwiVEVNUExBVEVfSUQiLCJkeW5hbWljX3RlbXBsYXRlX2RhdGEiLCJzdWJqZWN0IiwiY29kZSIsImZvciIsInNlbmQiLCJlcnIiLCJzdGF0dXMiLCJqc29uIiwiZXJyb3IiLCJtZXNzYWdlIiwiYWNjb3VudENyZWF0ZWQiLCJpc0VtYWlsU2VudCIsInNlbmRGb3Jnb3RQYXNzd29yZENvZGUiLCJmcm9tbmFtZSIsInNlbmRJbnZpdGVFbWFpbCIsImxpbmsiLCJJTlZJVEVfVEVNUExBVEVfSUQiLCJyb2xlIiwiaGVhZGluZyIsImRlc2NyaXB0aW9uIiwicHJlSGVhZGVyIiwicmFuZG9tU3RyaW5nIiwibnVtYmVyIiwiTWF0aCIsInJhbmRvbSIsInRvRml4ZWQiLCJzdWJzdHJpbmciXSwibWFwcGluZ3MiOiI7Ozs7Ozs7QUFBQSxNQUFNQSxNQUFNLEdBQUdDLE9BQU8sQ0FBQyxnQkFBRCxDQUF0QixDLENBQ0E7OztBQUNBRCxNQUFNLENBQUNFLFNBQVAsQ0FBaUJDLE9BQU8sQ0FBQ0MsR0FBUixDQUFZQyxnQkFBN0I7O0FBRUEsTUFBTUMsd0JBQXdCLEdBQUcsT0FBT0MsSUFBUCxFQUFhQyxHQUFiLEVBQWtCQyxHQUFsQixFQUF1QkMsTUFBTSxHQUFHLEtBQWhDLEtBQTBDO0FBQ3pFLFFBQU1DLEtBQUssR0FBR0osSUFBSSxDQUFDSyx5QkFBTCxFQUFkOztBQUNBLE1BQUk7QUFDRixVQUFN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QUcsR0FBRztBQUNWQyxNQUFBQSxFQUFFLEVBQUVSLElBQUksQ0FBQ1MsS0FEQztBQUVWQyxNQUFBQSxJQUFJLEVBQUU7QUFDSkQsUUFBQUEsS0FBSyxFQUFFYixPQUFPLENBQUNDLEdBQVIsQ0FBWWMsVUFEZjtBQUVKQyxRQUFBQSxJQUFJLEVBQUU7QUFGRixPQUZJO0FBT1ZDLE1BQUFBLFVBQVUsRUFBRWpCLE9BQU8sQ0FBQ0MsR0FBUixDQUFZa0Msa0JBUGQ7QUFRVmhCLE1BQUFBLHFCQUFxQixFQUFFO0FBQ3JCQyxRQUFBQSxPQUFPLEVBQUcsNEJBQTJCaEIsSUFBSSxDQUFDZ0MsSUFBSyxvQkFEMUI7QUFFckJDLFFBQUFBLE9BQU8sRUFBRSx3QkFGWTtBQUdyQkMsUUFBQUEsV0FBVyxFQUFHLDRCQUEyQmxDLElBQUksQ0FBQ2dDLElBQUssdUdBSDlCO0FBSXJCRyxRQUFBQSxTQUFTLEVBQUcsdURBSlM7QUFLckJMLFFBQUFBLElBQUksRUFBRUE7QUFMZTtBQVJiLEtBQVo7QUFpQkEsVUFBTXJDLE1BQU0sQ0FBQzBCLElBQVAsQ0FBWVosR0FBWixDQUFOO0FBQ0E7QUFDRCxHQXBCRCxDQW9CRSxPQUFPYSxHQUFQLEVBQVk7QUFDWixXQUFPbEIsR0FBRyxDQUFDbUIsTUFBSixDQUFXLEdBQVgsRUFBZ0JDLElBQWhCLENBQXFCO0FBQzFCQyxNQUFBQSxLQUFLLEVBQUVILEdBQUcsQ0FBQ0k7QUFEZSxLQUFyQixDQUFQO0FBR0Q7QUFDRixDQTFCRDs7OztBQTRCQSxNQUFNWSxZQUFZLEdBQUcsTUFBTTtBQUN6QixRQUFNQyxNQUFNLEdBQUdDLElBQUksQ0FBQ0MsTUFBTCxHQUFjQyxPQUFkLENBQXNCLEVBQXRCLEVBQTBCQyxTQUExQixDQUFvQyxDQUFwQyxFQUF1QyxDQUF2QyxDQUFmO0FBQ0EsU0FBT0osTUFBUDtBQUNELENBSEQiLCJzb3VyY2VzQ29udGVudCI6WyJjb25zdCBzZ01haWwgPSByZXF1aXJlKCdAc2VuZGdyaWQvbWFpbCcpO1xuLy9jb25zdCBUb2tlbiA9IHJlcXVpcmUoJy4uL2FwaS9tb2RlbHMvdG9rZW4nKTtcbnNnTWFpbC5zZXRBcGlLZXkocHJvY2Vzcy5lbnYuU0VOREdSSURfQVBJX0tFWSk7XG5cbmNvbnN0IHNlbmRFbWFpbFRvVmVyaWZ5QWNjb3VudCA9IGFzeW5jICh1c2VyLCByZXEsIHJlcywgcmVzZW5kID0gZmFsc2UpID0+IHtcbiAgY29uc3QgdG9rZW4gPSB1c2VyLmdlbmVyYXRlVmVyaWZpY2F0aW9uVG9rZW4oKTtcbiAgdHJ5IHtcbiAgICBhd2FpdCB0b2tlbi5zYXZlKCk7XG4gICAgY29uc3QgbXNnID0ge1xuICAgICAgdG86IHVzZXIuZW1haWwsXG4gICAgICBmcm9tOiB7XG4gICAgICAgIGVtYWlsOiBwcm9jZXNzLmVudi5TTVRQX0VNQUlMLFxuICAgICAgICBuYW1lOiAnSGFzaGxvZ2ljcycsXG4gICAgICB9LFxuICAgICAgdGVtcGxhdGVJZDogcHJvY2Vzcy5lbnYuVEVNUExBVEVfSUQsXG4gICAgICBkeW5hbWljX3RlbXBsYXRlX2RhdGE6IHtcbiAgICAgICAgc3ViamVjdDogJ1lvdXIgSGFzaGxvZ2ljcyBlbWFpbCB2ZXJpZmljYXRpb24gcmVxdWVzdCcsXG4gICAgICAgIC8vIG5hbWU6IGAke3VzZXIuZmlyc3ROYW1lfSAke3VzZXIubGFzdE5hbWV9YCxcbiAgICAgICAgY29kZTogdG9rZW4udG9rZW4sXG4gICAgICAgIGZvcjogJ3ZlcmlmeSB5b3VyIGFjY291bnQnLFxuICAgICAgfSxcbiAgICB9O1xuICAgIGF3YWl0IHNnTWFpbC5zZW5kKG1zZyk7XG4gICAgcmV0dXJuO1xuICB9IGNhdGNoIChlcnIpIHtcbiAgICBpZiAocmVzZW5kID09PSB0cnVlKSB7XG4gICAgICByZXR1cm4gcmVzLnN0YXR1cyg1MDApLmpzb24oe1xuICAgICAgICBlcnJvcjogZXJyLm1lc3NhZ2UsXG4gICAgICAgIG1lc3NhZ2U6ICdFbWFpbCBzZW5kaW5nIGZhaWxlZCcsXG4gICAgICB9KTtcbiAgICB9IGVsc2Uge1xuICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNTAwKS5qc29uKHtcbiAgICAgICAgZXJyb3I6IGVyci5tZXNzYWdlLFxuICAgICAgICBhY2NvdW50Q3JlYXRlZDogdHJ1ZSxcbiAgICAgICAgaXNFbWFpbFNlbnQ6IGZhbHNlLFxuICAgICAgICBtZXNzYWdlOlxuICAgICAgICAgICdBY2NvdW50IGlzIGNyZWF0ZWQgc3VjY2Vzc2Z1bGx5IC4gQnV0IGZhaWxlZCB0byBzZW5kIGVtYWlsLCBwbGVhc2Ugc2VuZCBlbWFpbCBhZ2FpbicsXG4gICAgICB9KTtcbiAgICB9XG4gIH1cbn07XG5jb25zdCBzZW5kRm9yZ290UGFzc3dvcmRDb2RlID0gYXN5bmMgKHVzZXIsIHJlcSwgcmVzKSA9PiB7XG4gIGNvbnN0IHRva2VuID0gdXNlci5nZW5lcmF0ZVZlcmlmaWNhdGlvblRva2VuKCk7XG4gIHRyeSB7XG4gICAgYXdhaXQgdG9rZW4uc2F2ZSgpO1xuICAgIGNvbnN0IG1zZyA9IHtcbiAgICAgIHRvOiB1c2VyLmVtYWlsLFxuICAgICAgZnJvbToge1xuICAgICAgICBlbWFpbDogcHJvY2Vzcy5lbnYuU01UUF9FTUFJTCxcbiAgICAgICAgbmFtZTogJ0hhc2hsb2dpY3MnLFxuICAgICAgfSxcbiAgICAgIHRlbXBsYXRlSWQ6IHByb2Nlc3MuZW52LlRFTVBMQVRFX0lELFxuICAgICAgZHluYW1pY190ZW1wbGF0ZV9kYXRhOiB7XG4gICAgICAgIHN1YmplY3Q6ICdZb3VyIEhhc2hsb2dpY3MgcGFzc3dvcmQgcmVzZXQgcmVxdWVzdCcsXG4gICAgICAgIC8vIG5hbWU6IGAke3VzZXIuZmlyc3ROYW1lfSAke3VzZXIubGFzdE5hbWV9YCxcbiAgICAgICAgY29kZTogdG9rZW4udG9rZW4sXG4gICAgICAgIGZyb21uYW1lOiAnSGFzaGxvZ2ljcycsXG4gICAgICAgIGZvcjogJ3Jlc2V0IHlvdXIgYWNjb3VudCcsXG4gICAgICB9LFxuICAgIH07XG4gICAgYXdhaXQgc2dNYWlsLnNlbmQobXNnKTtcbiAgICByZXMuc3RhdHVzKDIwMCkuanNvbih7XG4gICAgICBtZXNzYWdlOiAnWW91ciBhY2NvdW50IGhhcyBub3QgYmVlbiB2ZXJpZmllZCwgUGxlYXNlIGNoZWNrIHlvdXIgRW1haWwnLFxuICAgIH0pO1xuICB9IGNhdGNoIChlcnIpIHtcbiAgICByZXR1cm4gcmVzLnN0YXR1cyg1MDApLmpzb24oe1xuICAgICAgZXJyb3I6IGVyci5tZXNzYWdlLFxuICAgIH0pO1xuICB9XG59O1xuXG5jb25zdCBzZW5kSW52aXRlRW1haWwgPSBhc3luYyAodXNlciwgbGluaywgcmVxLCByZXMpID0+IHtcbiAgdHJ5IHtcbiAgICBjb25zdCBtc2cgPSB7XG4gICAgICB0bzogdXNlci5lbWFpbCxcbiAgICAgIGZyb206IHtcbiAgICAgICAgZW1haWw6IHByb2Nlc3MuZW52LlNNVFBfRU1BSUwsXG4gICAgICAgIG5hbWU6ICdIYXNobG9naWNzJyxcbiAgICAgIH0sXG5cbiAgICAgIHRlbXBsYXRlSWQ6IHByb2Nlc3MuZW52LklOVklURV9URU1QTEFURV9JRCxcbiAgICAgIGR5bmFtaWNfdGVtcGxhdGVfZGF0YToge1xuICAgICAgICBzdWJqZWN0OiBgWW91IGhhdmUgYmVlbiBhZGRlZCBhcyBhICR7dXNlci5yb2xlfSB3aXRoaW4gSGFzaGxvZ2ljc2AsXG4gICAgICAgIGhlYWRpbmc6ICdXZWxjb21lIHRvIEhhc2hsb2dpY3MhJyxcbiAgICAgICAgZGVzY3JpcHRpb246IGBZb3UgaGF2ZSBiZWVuIGFkZGVkIGFzIGEgJHt1c2VyLnJvbGV9IHdpdGhpbiBIYXNobG9naWNzLiBQbGVhc2UgZm9sbG93IHRoZSBsaW5rIGJlbG93IHRvIGdldCBzdGFydGVkIGFuZCB0byBzZXQgdXAgeW91ciBIYXNobG9naWNzIHByb2ZpbGVgLFxuICAgICAgICBwcmVIZWFkZXI6IGBZb3UgaGF2ZSBiZWVuIGFkZGVkIGFzIGEgc3VwZXJ2aXNvciB3aXRoaW4gSGFzaGxvZ2ljc2AsXG4gICAgICAgIGxpbms6IGxpbmssXG4gICAgICB9LFxuICAgIH07XG5cbiAgICBhd2FpdCBzZ01haWwuc2VuZChtc2cpO1xuICAgIHJldHVybjtcbiAgfSBjYXRjaCAoZXJyKSB7XG4gICAgcmV0dXJuIHJlcy5zdGF0dXMoNTAwKS5qc29uKHtcbiAgICAgIGVycm9yOiBlcnIubWVzc2FnZSxcbiAgICB9KTtcbiAgfVxufTtcblxuY29uc3QgcmFuZG9tU3RyaW5nID0gKCkgPT4ge1xuICBjb25zdCBudW1iZXIgPSBNYXRoLnJhbmRvbSgpLnRvRml4ZWQoMzYpLnN1YnN0cmluZygyLCA3KTtcbiAgcmV0dXJuIG51bWJlcjtcbn07XG5cbmV4cG9ydCB7XG4gIHJhbmRvbVN0cmluZyxcbiAgc2VuZEVtYWlsVG9WZXJpZnlBY2NvdW50LFxuICBzZW5kRm9yZ290UGFzc3dvcmRDb2RlLFxuICBzZW5kSW52aXRlRW1haWwsXG59O1xuIl19